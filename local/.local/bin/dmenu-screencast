#!/bin/sh

start_screencast() {
  local audio_flags=$1
  local filename=${2:-$(date +%Y-%m-%d-%H%M%S)}
  read -r X Y W H < <(slop -f "%x %y %w %h" --color=1,0,0)
  [[ -z $X ]] && exit 0
  notify-send "Screencast started"
  ffmpeg \
    -framerate 60 \
    -f x11grab \
    -s "$W"x"$H" \
    -i :0.0+$X,$Y \
    $audio_flags \
    ~/videos/screencasts/${filename// /-}.mp4
}

main() {
	pgrep -x ffmpeg && kill $(pgrep -x ffmpeg) && notify-send "Screencast stopped" && exit 0

	local choice=$(echo -e "yes\nno" | dmenu -i -p "screencast with sound?")
	local audio_flags=""
	case "$choice" in
	  "yes")
	    audio_flags="-f pulse -ac 2 -i default"
	    ;;
          "no")
	    ;;
          *)
            exit 0
	    ;;
        esac
	local name=$(echo "$(date +%Y-%m-%d-%H%M%S)" | dmenu -p "filename: ")
	start_screencast "$audio_flags" "$name"
}

main
